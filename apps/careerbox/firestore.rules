rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =============================================================================
    // HELPER FUNCTIONS
    // =============================================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if authenticated user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is admin (Custom Claims)
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.get('admin', false) == true;
    }
    
    // Check if user is moderator (Custom Claims)
    function isModerator() {
      return isAuthenticated() && 
             (request.auth.token.get('moderator', false) == true || isAdmin());
    }
    
    // Validate timestamp fields
    function hasValidTimestamp() {
      return request.resource.data.createdAt is timestamp;
    }
    
    // Check if user is participant in a conversation
    function isConversationMember(conversationData) {
      return isAuthenticated() && 
             request.auth.uid in conversationData.participants;
    }
    
    // =============================================================================
    // SECURITY RULES
    // =============================================================================
    
    // Job Seeker Profiles (Individuals)
    match /careerbox_individuals/{individualId} {
      // Anyone authenticated can read (for matching)
      allow read: if isAuthenticated();
      
      // Only owner can create their own profile
      allow create: if isOwner(request.resource.data.uid) && 
                      hasValidTimestamp();
      
      // Only owner can update (except sensitive fields)
      allow update: if isOwner(resource.data.uid) &&
                      !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['uid', 'createdAt', 'verified', 'suspended']);
      
      // Only owner or admin can delete
      allow delete: if isOwner(resource.data.uid) || isAdmin();
    }
    
    // Job Listings (Employers)
    match /careerbox_listings/{listingId} {
      // Anyone authenticated can read active listings
      allow read: if isAuthenticated() && 
                    (resource.data.status == 'active' || 
                     isOwner(resource.data.employerId) || 
                     isModerator());
      
      // Authenticated users can create listings
      allow create: if isAuthenticated() && 
                      isOwner(request.resource.data.employerId) &&
                      hasValidTimestamp() &&
                      request.resource.data.status == 'pending';
      
      // Only listing owner can update
      allow update: if isOwner(resource.data.employerId) &&
                      // Moderators can update status/visibility
                      (isModerator() || 
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['employerId', 'createdAt']));
      
      // Only owner or admin can delete
      allow delete: if isOwner(resource.data.employerId) || isAdmin();
    }
    
    // Job Matches
    match /careerbox_matches/{matchId} {
      // Users can read their own matches
      allow read: if isAuthenticated() && 
                    (isOwner(resource.data.individualUid) || 
                     isOwner(resource.data.employerId) ||
                     isModerator());
      
      // System creates matches (via server-side or Cloud Functions)
      // Users cannot directly create matches
      allow create: if false;
      
      // Users can update their match actions (accept/reject)
      allow update: if isAuthenticated() &&
                      (isOwner(resource.data.individualUid) || 
                       isOwner(resource.data.employerId));
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // Conversations
    match /careerbox_conversations/{conversationId} {
      // Participants can read their conversations
      allow read: if isConversationMember(resource.data) || isModerator();
      
      // Authenticated users can create conversations
      allow create: if isAuthenticated() &&
                      request.auth.uid in request.resource.data.participants &&
                      hasValidTimestamp();
      
      // Participants can update (e.g., mark as read, add metadata)
      allow update: if isConversationMember(resource.data);
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // Messages
    match /careerbox_messages/{messageId} {
      // Participants of the conversation can read messages
      allow read: if isAuthenticated() && 
                    (isOwner(resource.data.senderId) || 
                     isOwner(resource.data.recipientId) ||
                     isModerator());
      
      // Sender can create messages
      allow create: if isAuthenticated() &&
                      isOwner(request.resource.data.senderId) &&
                      hasValidTimestamp();
      
      // Sender can update their own messages (edit/delete flag)
      allow update: if isOwner(resource.data.senderId);
      
      // Only sender or admin can delete
      allow delete: if isOwner(resource.data.senderId) || isAdmin();
    }
    
    // Moderation Queue
    match /careerbox_moderation/{moderationId} {
      // Only moderators can read
      allow read: if isModerator();
      
      // System creates moderation records
      allow create: if isAuthenticated();
      
      // Only moderators can update (resolve, assign)
      allow update: if isModerator();
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // Saved Jobs (Bookmarks)
    match /careerbox_saved_jobs/{userId}/jobs/{jobId} {
      // Users can read their own saved jobs
      allow read: if isOwner(userId);
      
      // Users can save jobs
      allow create: if isOwner(userId) && hasValidTimestamp();
      
      // Users can update their saved jobs metadata
      allow update: if isOwner(userId);
      
      // Users can delete their saved jobs
      allow delete: if isOwner(userId);
    }
    
    // Applications
    match /careerbox_applications/{applicationId} {
      // Applicant and listing owner can read
      allow read: if isAuthenticated() &&
                    (isOwner(resource.data.applicantId) ||
                     isOwner(resource.data.employerId) ||
                     isModerator());
      
      // Authenticated users can apply
      allow create: if isAuthenticated() &&
                      isOwner(request.resource.data.applicantId) &&
                      hasValidTimestamp();
      
      // Applicant and employer can update status
      allow update: if isAuthenticated() &&
                      (isOwner(resource.data.applicantId) ||
                       isOwner(resource.data.employerId));
      
      // Only applicant or admin can delete
      allow delete: if isOwner(resource.data.applicantId) || isAdmin();
    }
    
    // =============================================================================
    // DENY ALL OTHER COLLECTIONS
    // =============================================================================
    
    // Explicitly deny access to any unlisted collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
